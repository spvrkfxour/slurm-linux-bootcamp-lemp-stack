# -*- mode: ruby -*-
# vi: set ft=ruby :

# МАГИЯ ДЛЯ РФ (Обход блокировок)
# Указываем альтернативное зеркало для скачивания образов
ENV['VAGRANT_SERVER_URL'] = 'https://vagrant.elab.pro'

Vagrant.configure("2") do |config|
  # ============================================================================
  # ОСНОВНЫЕ ПАРАМЕТРЫ ВИРТУАЛЬНОЙ МАШИНЫ
  # ============================================================================
  
  # Имя виртуальной машины (используется для идентификации в VirtualBox)
  config.vm.define "bootcamp-vm" do |vm|
    # Hostname внутри виртуальной машины
    vm.vm.hostname = "bootcamp-vm"
    
    # Образ операционной системы
    # Используем популярный готовый образ Ubuntu 24.04
    # Фиксируем версию для воспроизводимости окружения
    vm.vm.box = "bento/ubuntu-24.04"
    
    # ========================================================================
    # НАСТРОЙКА СЕТИ
    # ========================================================================
    
    # Приватная сеть с автоматическим получением IP через DHCP
    # Можно также использовать статический IP: ip: "192.168.56.10"
    vm.vm.network "private_network", ip: "192.168.56.10"
    
    # Проброс портов (пример, можно добавить по необходимости)
    # vm.vm.network "forwarded_port", guest: 80, host: 8080
    
    # ========================================================================
    # НАСТРОЙКА ПРОВАЙДЕРА VIRTUALBOX
    # ========================================================================
    
    # ========================================================================
    # НАСТРОЙКА ДИСКА
    # ========================================================================
    
    # Создаем дополнительный диск (опционально)
    # Размер указывается с единицами измерения (GB, MB, KB)
    # Примечание: для изменения размера основного диска используйте плагин vagrant-disksize
    # или настройки провайдера через vb.customize
    # vm.vm.disk :disk, size: "20GB", name: "bootcamp-data-disk", primary: false
    
    # ========================================================================
    # НАСТРОЙКА ПРОВАЙДЕРА VIRTUALBOX
    # ========================================================================
    
    vm.vm.provider "virtualbox" do |vb|
      # Имя виртуальной машины в VirtualBox
      vb.name = "bootcamp-vm"
      
      # Ресурсы виртуальной машины
      vb.memory = 2048  # 2 ГБ оперативной памяти
      vb.cpus = 2       # 2 ядра процессора
      
      # Запуск без графического интерфейса (headless mode)
      vb.gui = false
      
      # Настройка размера основного диска (если нужно изменить стандартный размер)
      # По умолчанию VirtualBox создает диск 10 ГБ, можно увеличить через:
      # vb.customize ["modifyvm", :id, "--hda", "path/to/disk.vdi"]
      # Или использовать плагин vagrant-disksize
    end
    
    # ========================================================================
    # ОТКЛЮЧЕНИЕ ГОСТЕВЫХ ДОПОЛНЕНИЙ (Guest Additions)
    # ========================================================================
    
    # Плагин vbguest автоматически устанавливает/обновляет Guest Additions
    # Отключаем автоматическую установку и обновление для ускорения работы
    # Это предотвращает задержки при запуске VM и конфликты версий
    if Vagrant.has_plugin?("vagrant-vbguest")
      vm.vbguest.auto_update = false
      vm.vbguest.no_install = true
      vm.vbguest.no_remote = true
    end
    
    # Альтернативный способ: отключение через конфигурацию провайдера
    # config.vm.guest = :linux
    # config.ssh.insert_key = false  # Не вставлять новый SSH ключ при каждом запуске
    
    # ========================================================================
    # ПРОВИЖЕНИНГ (Установка ПО и настройка системы)
    # ========================================================================
    
    # Inline shell provisioner - выполнение команд при первой инициализации VM
    # ВАЖНО: Это выполняется только при первом запуске (vagrant up)
    # Для повторного выполнения используйте: vagrant provision
    # 
    # АЛЬТЕРНАТИВЫ:
    # 1. Вынести в отдельный bash-скрипт: vm.vm.provision "shell", path: "scripts/bootstrap.sh"
    # 2. Использовать Ansible: vm.vm.provision "ansible" do |ansible| ... end
    # 3. Использовать Puppet/Chef для более сложных конфигураций
    
    vm.vm.provision "shell", inline: <<-SHELL
      # Обновление списка пакетов
      sudo apt-get update
      
      # Установка базовых утилит
      sudo apt-get install -y \
        mc \
        htop \
        vim \
        curl \
        wget \
        git \
        tree \
        net-tools \
        iputils-ping \
        unzip \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release
      
      # Очистка кэша пакетов для экономии места
      sudo apt-get clean
      sudo apt-get autoremove -y
      
      # Создание директории для проектов (пример)
      mkdir -p /home/vagrant/projects
      
      # Вывод информации о системе
      echo "=========================================="
      echo "Виртуальная машина успешно настроена!"
      echo "Установлены базовые утилиты: mc, htop, vim, curl, wget, git и др."
      echo "=========================================="
    SHELL
    
    # Пример использования внешнего скрипта (закомментировано)
    # vm.vm.provision "shell", path: "scripts/bootstrap.sh", privileged: true
    
    # Пример использования Ansible (закомментировано)
    # vm.vm.provision "ansible" do |ansible|
    #   ansible.playbook = "playbooks/bootstrap.yml"
    #   ansible.verbose = true
    # end
  end
  
  # ============================================================================
  # ГЛОБАЛЬНЫЕ НАСТРОЙКИ
  # ============================================================================

  
  # Синхронизация папок
  # По умолчанию текущая директория монтируется в /vagrant
  # Можно настроить дополнительные папки:
  # config.vm.synced_folder "./data", "/vagrant_data", create: true
end

